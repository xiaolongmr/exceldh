# 聊天室语音功能说明

## 功能概述

为聊天室添加语音录音、上传、自动发送和播放功能。

## 主要特性

### 1. 录音功能
- **按住录音**：按住语音按钮开始录音，松开停止
- **时长限制**：最长30秒，最短1秒
- **实时计时**：显示录音时长
- **自动停止**：30秒后自动停止录音

### 2. 自动上传
- **格式**：audio/webm
- **上传目标**：Telegram 图床（uploadFolder: v）
- **文件名**：voice-时间戳.webm
- **自动发送**：上传成功后自动发送

### 3. 语音消息展示
- **自动识别**：.webm 链接自动渲染为播放器
- **播放控制**：支持播放/暂停、进度条
- **美观界面**：现代化语音消息样式

### 4. 兼容性
- **浏览器支持**：Chrome、Firefox、Safari、Edge
- **移动端支持**：触摸设备录音
- **权限管理**：自动检测麦克风权限

## 使用方法

### 发送语音消息
1. 点击"语音"按钮
2. 按住按钮开始录音（按钮变红）
3. 说话
4. 松开按钮停止录音
5. 系统自动上传并发送

### 播放语音消息
- 语音消息自动渲染为播放器
- 点击播放按钮收听

## 技术实现

### 录音技术
```javascript
const mediaRecorder = new MediaRecorder(stream, {
    mimeType: 'audio/webm'
});
```

### 自动发送机制
```javascript
// 防死循环锁
if (voiceAutoSendLock) return;
voiceAutoSendLock = true;
// 自动发送逻辑
setTimeout(() => voiceAutoSendLock = false, 1000);
```

## 配置参数

```javascript
const VOICE_CONFIG = {
    MAX_RECORD_TIME: 30000,    // 最大录音时长30秒
    MIN_RECORD_TIME: 1000,     // 最小录音时长1秒
    UPLOAD_FOLDER: "v",        // 语音文件上传文件夹
};
```

## 错误处理

### 权限错误
- **NotAllowedError**：用户拒绝麦克风权限
- **NotFoundError**：未找到麦克风设备

### 录音错误
- **录音过短**：少于1秒的录音会被拒绝
- **文件无效**：0KB的录音文件会被拒绝
- **上传失败**：网络错误或服务器错误

## 安全考虑

### 权限控制
- 仅在用户授权后使用麦克风
- 录音结束后立即释放资源

### 文件限制
- 录音时长限制防止滥用
- 文件大小检查

### 域名白名单
- 仅允许指定域名使用语音功能

## 测试方法

### 功能测试
- 测试浏览器兼容性
- 测试麦克风权限
- 测试录音功能
- 测试语音消息渲染

## 故障排除

### 语音按钮不显示
- 检查浏览器是否支持相关API
- 检查域名是否在白名单内

### 录音失败
- 检查麦克风权限设置
- 检查是否有其他应用占用麦克风

### 上传失败
- 检查网络连接
- 检查服务器状态

## 更新日志

### v1.0.0
- 实现基础录音功能
- 实现自动上传和发送
- 实现语音消息渲染
- 添加完整的错误处理
- 添加兼容性检查

## 技术支持

如有问题，请：
- 在聊天室中反馈
- 查看浏览器控制台错误信息
- 参考本文档进行故障排除 