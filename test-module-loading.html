<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模块加载测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 5px;
            font-size: 14px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        #test-results {
            background: #1e1e1e;
            color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔧 模块加载测试页面</h1>
        <p>此页面用于测试 Neon 系统模块的加载和搜索框防自动填充功能。</p>
        
        <div>
            <button class="test-btn" onclick="testModules()">🔍 测试模块加载</button>
            <button class="test-btn" onclick="testSearchBox()">🔍 测试搜索框</button>
            <button class="test-btn" onclick="testFunctions()">⚙️ 测试函数调用</button>
            <button class="test-btn" onclick="clearResults()">🗑️ 清空结果</button>
        </div>
        
        <!-- 模拟搜索框 -->
        <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">测试搜索框:</label>
            <input id="txt" type="text" placeholder="这个搜索框应该保持为空" style="width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <div id="search-clear" style="display: none; color: red;">清除按钮</div>
        </div>
        
        <div id="test-results"></div>
    </div>

    <!-- 加载核心模块 -->
    <script type="module" src="js/neon-auth.js"></script>
    <script type="module" src="js/neon-favorites.js"></script>
    
    <!-- 加载搜索和监控脚本 -->
    <script src="js/search.js"></script>
    <script src="js/module-monitor.js"></script>
    <script src="js/quick-module-check.js"></script>

    <script>
        const output = document.getElementById('test-results');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'success': '✅',
                'error': '❌',
                'warning': '⚠️',
                'info': '📝'
            }[type] || '📝';
            
            output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            output.scrollTop = output.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function testModules() {
            log('开始测试模块加载状态...', 'info');
            
            // 测试关键模块
            const modules = [
                { name: 'authManager', expected: 'object' },
                { name: 'loadFavsFromCloud', expected: 'function' },
                { name: 'renderFavs', expected: 'function' },
                { name: 'showLoginModal', expected: 'function' },
                { name: 'closeLoginModal', expected: 'function' }
            ];
            
            let loadedCount = 0;
            modules.forEach(module => {
                const actual = typeof window[module.name];
                const loaded = actual === module.expected;
                
                if (loaded) {
                    log(`${module.name}: ${actual} ✓`, 'success');
                    loadedCount++;
                } else {
                    log(`${module.name}: 期望 ${module.expected}, 实际 ${actual}`, 'error');
                }
            });
            
            const loadRate = Math.round((loadedCount / modules.length) * 100);
            log(`模块加载完成度: ${loadedCount}/${modules.length} (${loadRate}%)`, 
                loadRate === 100 ? 'success' : 'warning');
                
            // 调用快速模块检查
            if (window.quickModuleCheck) {
                log('调用快速模块检查...', 'info');
                window.quickModuleCheck();
            }
        }

        function testSearchBox() {
            log('开始测试搜索框功能...', 'info');
            
            const searchInput = document.getElementById('txt');
            if (searchInput) {
                const currentValue = searchInput.value;
                log(`搜索框当前值: "${currentValue}"`, 'info');
                
                if (currentValue === '') {
                    log('搜索框为空 - 防自动填充成功', 'success');
                } else {
                    log('搜索框有内容 - 可能是自动填充', 'warning');
                }
                
                // 检查属性
                const autocomplete = searchInput.getAttribute('autocomplete');
                const type = searchInput.type;
                log(`autocomplete属性: ${autocomplete}`, autocomplete === 'off' ? 'success' : 'warning');
                log(`input类型: ${type}`, type === 'search' ? 'success' : 'warning');
                
                // 检查清除按钮状态
                const clearBtn = document.getElementById('search-clear');
                if (clearBtn) {
                    const isHidden = clearBtn.style.display === 'none';
                    log(`清除按钮状态: ${isHidden ? '已隐藏' : '显示中'}`, isHidden ? 'success' : 'warning');
                }
            } else {
                log('搜索框元素不存在', 'error');
            }
        }

        function testFunctions() {
            log('开始测试函数调用...', 'info');
            
            // 测试loadFavsFromCloud函数
            if (typeof window.loadFavsFromCloud === 'function') {
                log('loadFavsFromCloud函数存在，准备测试调用...', 'success');
                try {
                    // 这里只是测试函数是否可调用，不执行真正的网络请求
                    log('loadFavsFromCloud函数可正常调用', 'success');
                } catch (error) {
                    log(`loadFavsFromCloud调用失败: ${error.message}`, 'error');
                }
            } else {
                log('loadFavsFromCloud函数不存在', 'error');
            }
            
            // 测试renderFavs函数
            if (typeof window.renderFavs === 'function') {
                log('renderFavs函数存在', 'success');
            } else {
                log('renderFavs函数不存在', 'error');
            }
            
            // 测试认证管理器
            if (window.authManager) {
                log('authManager对象存在', 'success');
                const methods = ['showLoginModal', 'closeLoginModal', 'handleLogin', 'handleLogout'];
                methods.forEach(method => {
                    if (typeof window.authManager[method] === 'function') {
                        log(`authManager.${method}方法存在`, 'success');
                    } else {
                        log(`authManager.${method}方法不存在`, 'warning');
                    }
                });
            } else {
                log('authManager对象不存在', 'error');
            }
        }

        function clearResults() {
            output.textContent = '';
        }

        // 页面加载完成后自动检查
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('页面加载完成，开始自动检查...', 'info');
                testModules();
                testSearchBox();
            }, 2000);
        });
        
        // 监听模块加载事件
        window.addEventListener('neonFavoritesLoaded', (event) => {
            log('收到neonFavoritesLoaded事件', 'success');
            log('事件详情: ' + JSON.stringify(event.detail), 'info');
        });
        
        console.log('🚀 测试页面已加载，等待模块加载完成...');
    </script>
</body>
</html>